<script>
import {onMounted, onUnmounted, ref} from 'vue';
import * as THREE from 'three';
import {TextureLoader} from 'three';
import {OrbitControls} from "three/examples/jsm/controls/OrbitControls";
import {GLTFLoader} from 'three/examples/jsm/loaders/GLTFLoader';
import CanvasFullScreen from '@/components/util/CanvasFullScreen.vue';
import ToggleFullScreen from '@/components/util/ToggleFullScreen.vue';
import {openGraphMixin} from '@/assets/ogimage/openGraphMixin';

export default {
  name: 'Project3',
  mixins: [openGraphMixin],
  components: { CanvasFullScreen, ToggleFullScreen },
  mounted() {
    const mainTitle = 'Model selection';
    const title = 'Couture Metaverse 3D - Model selection';
    const metaDescription = 'Couture Metaverse 3D';
    const description = 'Couture Metaverse 3D - Model selection';
    const imageUrl = 'https://couture-metaverse.vercel.app/assets/ogimage/bmp/project3.jpg';
    const url = 'https://couture-metaverse.vercel.app/project3';

    this.setOpenGraphTags(metaDescription, title, description, imageUrl, url);
    this.setPageTitle(mainTitle);
  },
  setup() {
    const canvasContainer = ref(null);
    let scene, camera, renderer, model;
    let sceneGroup = null; // –≠—Ç–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
    const isMultiModelView = ref(false);
    let modelList = [];

    // –§–ª–∞–≥ –¥–ª—è —Å–º–µ—à–∏–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç—É—Ä –∏ —Ü–≤–µ—Ç–æ–≤
    const isMixingEnabled = ref(false);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
    const loadStoredModels = () => {
      try {
        const storedModels = localStorage.getItem('modelsSettings');
        return storedModels ? JSON.parse(storedModels) : null;
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–¥–µ–ª–µ–π:", error);
        return null;
      }
    };

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
    const saveModelsToStorage = () => {
      localStorage.setItem('modelsSettings', JSON.stringify(models));
    };

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const models = loadStoredModels() || {
      menShirt1: {
        path: '/assets/models/01_men_shirt.glb',
        name: 'Male regular T-shirt',
        icon: '/assets/img/models/01_men_shirt.webp',
        originalSettings: {
          texture: '/assets/textures/materialTexture1.webp', // –ü—É—Ç—å –∫ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–µ–∫—Å—Ç—É—Ä–µ
          color: new THREE.Color(0xffffff), // –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç
          roughness: 0.1,
          metalness: 0.5,
          brightnessMultiplier: 4.5, // –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ –¥–ª—è –º–æ–¥–µ–ª–∏
        },
        settings: {},
      },
      womenShirt: {
        path: '/assets/models/02_women_shirt.glb',
        name: 'Women oversized T-shirt',
        icon: '/assets/img/models/02_women_shirt.webp',
        originalSettings: {
          texture: '/assets/textures/materialTexture2.webp',
          color: new THREE.Color(0xffffff), // –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç
          roughness: 0.1,
          metalness: 0.5,
          brightnessMultiplier: 4.5,
        },
        settings: {},
      },
      menShirt2: {
        path: '/assets/models/03_men_shirt.glb',
        name: 'Male raglan polo T-shirt',
        icon: '/assets/img/models/03_men_shirt.webp',
        originalSettings: {
          texture: '/assets/textures/materialTexture3.webp',
          color: new THREE.Color(0xffffff), // –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç
          roughness: 0.1,
          metalness: 0.5,
          brightnessMultiplier: 4.5,
        },
        settings: {},
      },
      womenDress: {
        path: '/assets/models/04_dress.glb',
        name: 'Mid Victorian Evening Gown',
        icon: '/assets/img/models/04_dress.webp',
        originalSettings: {
          texture: '/assets/textures/materialTexture1.webp',
          color: new THREE.Color(0xffffff), // –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç
          roughness: 0.1,
          metalness: 0.5,
          brightnessMultiplier: 4.5,
        },
        settings: {},
      },
    };

    const storedModels = localStorage.getItem('modelsSettings');

    if (storedModels) {
      const parsedModels = JSON.parse(storedModels); // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
      for (const key in models) {
        if (parsedModels[key]) {
          models[key].settings = parsedModels[key].settings; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        } else {
          models[key].settings = { ...models[key].originalSettings }; // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
        }
      }
    } else {
      // –ö–æ–ø–∏—Ä—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      for (const key in models) {
        models[key].settings = { ...models[key].originalSettings };
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏
    const loadModel = async (modelKey) => {
      isMultiModelView.value = false; // üìå –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      clearScene(); // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ü–µ–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏

      // –°–æ–∑–¥–∞—ë–º `sceneGroup`, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ—Å—å –≤—Ä–∞—â–µ–Ω–∏–µ
      sceneGroup = new THREE.Group();
      scene.add(sceneGroup);

      const loader = new GLTFLoader();
      try {
        const gltf = await loader.loadAsync(models[modelKey].path);
        model = gltf.scene;

        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞
        model.userData.modelKey = modelKey;

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å –≤ —Å—Ü–µ–Ω–µ
        model.position.set(0, 0, 0);
        model.scale.set(4, 4, 4);

        // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –≤ `sceneGroup`
        sceneGroup.add(model);

        // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –≤ rotationStates
        rotationStates.set(modelKey, { clockwise: false, counterClockwise: false });

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Ç–µ–∫—Å—Ç—É—Ä—ã
        const materialPromises = [];
        model.traverse((child) => {
          if (child instanceof THREE.Mesh && child.material) {
            materialPromises.push(applyMaterialSettings(child.material, modelKey));
          }
        });

        await Promise.all(materialPromises);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –º–æ–¥–µ–ª–∏ (bounding box)
        const boundingBox = new THREE.Box3().setFromObject(model);
        const height = boundingBox.max.y - boundingBox.min.y;
        // –°–¥–≤–∏–≥–∞–µ–º –º–æ–¥–µ–ª—å –≤–Ω–∏–∑
        model.position.y = -height / 2;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É —Å—Ç–∞–ª–∏ –≤–∏–¥–Ω—ã
        requestAnimationFrame(() => renderer.render(scene, camera));

      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ ${modelKey}:`, error);
      }
    };

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
    const loadAllModels = async () => {
      isMultiModelView.value = true; // üìå –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      clearScene(); // –û—á–∏—Å—Ç–∫–∞ —Å—Ü–µ–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
      const loader = new GLTFLoader();
      const totalModels = Object.keys(models).length;

      // –°–æ–∑–¥–∞—ë–º –≥—Ä—É–ø–ø—É –¥–ª—è –º–æ–¥–µ–ª–µ–π
      sceneGroup = new THREE.Group();
      scene.add(sceneGroup);

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
      let maxModelHeight = 0;
      let maxModelWidth = 0;
      let modelsArray = [];

      // 1Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –∏ –≤—ã—á–∏—Å–ª—è–µ–º –∏—Ö —Ä–∞–∑–º–µ—Ä—ã
      let modelPromises = Object.keys(models).map(async (key, index) => {
        try {
          const gltf = await loader.loadAsync(models[key].path);
          const model = gltf.scene;
          model.userData.modelKey = key;

          // –í—ã—á–∏—Å–ª—è–µ–º boundingBox
          let boundingBox = new THREE.Box3().setFromObject(model);
          const modelWidth = boundingBox.max.x - boundingBox.min.x;
          const modelHeight = boundingBox.max.y - boundingBox.min.y;

          maxModelWidth = Math.max(maxModelWidth, modelWidth);
          maxModelHeight = Math.max(maxModelHeight, modelHeight);

          console.log(`‚úÖ ${key}: –í—ã—Å–æ—Ç–∞ = ${modelHeight}, –®–∏—Ä–∏–Ω–∞ = ${modelWidth}`);

          modelsArray[index] = model; // **–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –º–æ–¥–µ–ª–µ–π**

          // üìå –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –≤ rotationStates (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
          rotationStates.set(key, { clockwise: false, counterClockwise: false });

        } catch (error) {
          console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ ${key}:`, error);
        }
      });

      // –ñ–¥—ë–º, –ø–æ–∫–∞ –≤—Å–µ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è
      await Promise.all(modelPromises);
      console.log(`üìè –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞: ${maxModelHeight}, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞: ${maxModelWidth}`);

      // 2Ô∏è‚É£ –í—Ç–æ—Ä–æ–π –ø—Ä–æ—Ö–æ–¥ ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
      let materialPromises = [];
      const spacing = maxModelWidth * 3.2; // –ë–û–õ–¨–®–ï –æ—Ç—Å—Ç—É–ø–æ–≤ –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏
      let startX = -(totalModels - 1) * spacing / 2;

      modelsArray.forEach((model, index) => {
        const modelKey = model.userData.modelKey;

        // 1. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º boundingBox –¥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        let boundingBox = new THREE.Box3().setFromObject(model);

        // 2. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –∏—Ö –≤—ã—Å–æ—Ç–∞ ‚âà 1.8 (—É–º–µ–Ω—å—à–∞–µ–º!)
        const scaleFactor = 1.8 / maxModelHeight;
        model.scale.set(scaleFactor, scaleFactor, scaleFactor);

        // 3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º boundingBox –ø–æ—Å–ª–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        boundingBox.setFromObject(model);

        // 4. –†–∞–∑–º–µ—â–∞–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –æ—Å–∏ X, —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ
        model.position.x = startX + index * spacing;

        console.log(`üìç ${modelKey} -> X: ${model.position.x}, Y: ${model.position.y}, –ú–∞—Å—à—Ç–∞–±: ${scaleFactor}`);

        // 5. –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Ç–µ–∫—Å—Ç—É—Ä—ã
        model.traverse((child) => {
          if (child instanceof THREE.Mesh && child.material) {
            materialPromises.push(applyMaterialSettings(child.material, modelKey));
          }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –≤ —Å—Ü–µ–Ω—É (–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ!)
        sceneGroup.add(model);
      });

      // –ñ–¥—ë–º, –ø–æ–∫–∞ –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ–±–Ω–æ–≤—è—Ç—Å—è
      await Promise.all(materialPromises);

      // 6Ô∏è‚É£ –°–¥–≤–∏–≥–∞–µ–º –≤—Å—é –≥—Ä—É–ø–ø—É –≤–Ω–∏–∑, —á—Ç–æ–±—ã –æ–Ω–∞ —Å—Ç–æ—è–ª–∞ –Ω–∞ "–ø–æ–ª—É"
      const groupBoundingBox = new THREE.Box3().setFromObject(sceneGroup);
      const groupHeight = groupBoundingBox.max.y - groupBoundingBox.min.y;
      sceneGroup.position.y = -groupBoundingBox.min.y - groupHeight * 0.5;

      console.log(`üéØ –ì—Ä—É–ø–ø–∞ -> X: ${sceneGroup.position.x}, Y: ${sceneGroup.position.y}`);

      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—Ü–µ–Ω—É –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
      requestAnimationFrame(() => renderer.render(scene, camera));
      console.log("üéâ –í—Å–µ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø–∞–Ω–µ–ª—å —Å–∫—Ä—ã—Ç–∞!");
    };

    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ü–µ–Ω—ã
    const clearScene = () => {
      // –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É —Å –º–æ–¥–µ–ª—è–º–∏, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (sceneGroup) {
        scene.remove(sceneGroup); // –£–±–∏—Ä–∞–µ–º –≥—Ä—É–ø–ø—É
        sceneGroup.traverse((child) => {
          if (child instanceof THREE.Mesh) {
            if (child.material) {
              if (Array.isArray(child.material)) {
                child.material.forEach((mat) => mat.dispose());
              } else {
                child.material.dispose();
              }
            }
            if (child.geometry) {
              child.geometry.dispose();
            }
          }
        });
        sceneGroup = null; // –û–±–Ω—É–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≥—Ä—É–ø–ø—É
      }

      // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å
      if (model) {
        scene.remove(model); // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å
        model.traverse((child) => {
          if (child instanceof THREE.Mesh) {
            if (child.material) {
              if (Array.isArray(child.material)) {
                child.material.forEach((mat) => mat.dispose());
              } else {
                child.material.dispose();
              }
            }
            if (child.geometry) {
              child.geometry.dispose();
            }
          }
        });
        model = null; // –û–±–Ω—É–ª—è–µ–º —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å
      }

      // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π (–¥–ª—è loadAllModels)
      if (modelList && modelList.length > 0) {
        modelList.forEach((m) => {
          scene.remove(m);
          m.traverse((child) => {
            if (child instanceof THREE.Mesh) {
              if (child.material) {
                if (Array.isArray(child.material)) {
                  child.material.forEach((mat) => mat.dispose());
                } else {
                  child.material.dispose();
                }
              }
              if (child.geometry) {
                child.geometry.dispose();
              }
            }
          });
        });
        modelList = []; // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
      }
    };

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç—É—Ä
    const textures = {
      texture1: '/assets/textures/texture2.webp',
      texture2: '/assets/textures/texture5.webp',
    };

    const textureLoader = new TextureLoader();
    const textureCache = {};
    const getTexture = (path) => {
      if (!textureCache[path]) {
        textureCache[path] = textureLoader.load(path);
      }
      return textureCache[path];
    };

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    const applyMaterialSettings = async (material, modelKey) => {
      if (!models[modelKey]) {
        console.warn(`‚ö†Ô∏è –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –º–æ–¥–µ–ª–∏: ${modelKey}`);
        return;
      }

      const settings = models[modelKey].settings;
      if (!settings) return;

      let needsUpdate = false;

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ü–≤–µ—Ç –∏–∑ HEX –≤ THREE.Color, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      const newColor = new THREE.Color(settings.color);
      newColor.multiplyScalar(settings.brightnessMultiplier); // –ü—Ä–∏–º–µ–Ω—è–µ–º —è—Ä–∫–æ—Å—Ç—å

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
      const newTexture = settings.texture ? await getTexture(settings.texture) : null;

      // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ - –ø—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∏ —Ç–µ–∫—Å—Ç—É—Ä—É –≤–º–µ—Å—Ç–µ
      if (isMixingEnabled.value && settings.texture) {
        if (!material.color.equals(newColor)) {
          material.color.set(newColor);
          needsUpdate = true;
        }
        if (material.map !== newTexture) {
          material.map = newTexture; // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
          needsUpdate = true;
        }
      }
      // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç—É—Ä–∞ –∑–∞–¥–∞–Ω–∞, –Ω–æ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ - –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç—É—Ä—É
      else if (!isMixingEnabled.value && settings.texture) {
        if (!material.color.equals(newColor)) {
          material.color.set(newColor);
          needsUpdate = true;
        }
        if (material.map !== newTexture) {
          material.map = newTexture;
          needsUpdate = true;
        }
      }
      // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç—É—Ä—ã –Ω–µ—Ç - –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç
      else {
        if (!material.color.equals(newColor)) {
          material.color.set(newColor);
          needsUpdate = true;
        }
        if (material.map) {
          material.map = null;
          needsUpdate = true;
        }
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º roughness –∏ metalness
      if (material.roughness !== settings.roughness || material.metalness !== settings.metalness) {
        material.roughness = settings.roughness;
        material.metalness = settings.metalness;
        needsUpdate = true;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ü–µ–Ω—É, –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      if (needsUpdate) {
        material.needsUpdate = true;
        // setTimeout(() => renderer.render(scene, camera), 50); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        renderer.render(scene, camera);
      }
    };

    const init = () => {
      // –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω—É
      scene = new THREE.Scene();

      // –°–æ–∑–¥–∞–µ–º –∫–∞–º–µ—Ä—É
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 3;

      // –°–æ–∑–¥–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä
      renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.addEventListener('change', () => renderer.render(scene, camera));

      scene.add(camera);

      // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–µ
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 10, 5);
      scene.add(directionalLight);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      loadModel('womenShirt'); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∂–µ–Ω—Å–∫–∞—è —Ä—É–±–∞—à–∫–∞

      // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      canvasContainer.value.appendChild(renderer.domElement);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ü–µ–Ω—É
      const animate = () => {
        requestAnimationFrame(animate);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ `sceneGroup`
        if (sceneGroup && sceneGroup.children.length > 0) {
          sceneGroup.children.forEach((model) => {
            const modelKey = model.userData.modelKey;
            const state = rotationStates.get(modelKey);

            if (state?.clockwise) model.rotation.y += 0.01;
            else if (state?.counterClockwise) model.rotation.y -= 0.01;
          });
        }

        controls.update();
        renderer.render(scene, camera);
      };

      animate();
    };

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –º–æ–¥–µ–ª–∏
    const updateMaterials = (callback) => {
      return new Promise((resolve) => {
        if (!model) return resolve();  // –ï—Å–ª–∏ –Ω–µ—Ç –º–æ–¥–µ–ª–∏, —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º Promise

        model.traverse((child) => {
          if (child instanceof THREE.Mesh) {
            const materials = Array.isArray(child.material) ? child.material : [child.material];
            materials.forEach((material) => {
              if (material instanceof THREE.MeshStandardMaterial) {
                callback(material);
              }
            });
          }
        });

        resolve(); // –ö–æ–≥–¥–∞ traverse –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º Promise
      });
    };


    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏
    const changeColor = (colorHex) => {
      if (!model) return;
      const modelKey = model.userData.modelKey;
      if (!modelKey) return;

      models[modelKey].settings.color = new THREE.Color(colorHex); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏
      if (!isMixingEnabled.value) {
        models[modelKey].settings.texture = null; // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É, –µ—Å–ª–∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ
      }

      saveModelsToStorage();
      updateMaterials((material) => {applyMaterialSettings(material, modelKey);});

      // setTimeout(() => renderer.render(scene, camera), 50); // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ü–≤–µ—Ç–∞
      renderer.render(scene, camera);
    };

    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç—É—Ä—ã –º–æ–¥–µ–ª–∏
    const changeTexture = (textureKey) => {
      if (!model) return;
      const modelKey = model.userData.modelKey;
      if (!modelKey || !textures[textureKey]) return;

      models[modelKey].settings.texture = textures[textureKey]; // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏
      if (!isMixingEnabled.value) {
        models[modelKey].settings.color = models[modelKey].originalSettings.color; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–≤–µ—Ç –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É, –µ—Å–ª–∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ
      }

      saveModelsToStorage();
      updateMaterials((material) => {applyMaterialSettings(material, modelKey);});

      // setTimeout(() => renderer.render(scene, camera), 50); // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ç–µ–∫—Å—Ç—É—Ä—ã
      renderer.render(scene, camera);
    };

    const toggleMixing = () => {
      isMixingEnabled.value = !isMixingEnabled.value;
      updateMaterials((material) => {applyMaterialSettings(material);});
      saveModelsToStorage(); // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä—ã —Å –¥–∏—Å–∫–∞ (FileReader.readAsDataURL())
    const uploadTexture = async (event) => {
      // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∏–∑ —Å–æ–±—ã—Ç–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
      const file = event.target.files[0];
      if (!file || !model) return;  // –ï—Å–ª–∏ —Ñ–∞–π–ª –∏–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

      // –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
      const modelKey = model.userData.modelKey;
      if (!modelKey) return;

      // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç FileReader –¥–ª—è —á—Ç–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
      const reader = new FileReader();

      // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º FileReader –≤ Promise –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç—É—Ä—ã
      const loadTexture = new Promise((resolve, reject) => {
        // –ï—Å–ª–∏ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ, —Ä–∞–∑—Ä–µ—à–∞–µ–º Promise —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º (DataURL)
        reader.onload = function (e) {
          resolve(e.target.result);  // –ü–µ—Ä–µ–¥–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        };

        // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞, –æ—Ç–∫–ª–æ–Ω—è–µ–º Promise —Å –æ—à–∏–±–∫–æ–π
        reader.onerror = function (error) {
          reject(error);  // –û—Ç–∫–ª–æ–Ω—è–µ–º Promise —Å –æ—à–∏–±–∫–æ–π
        };

        // –ó–∞–ø—É—Å–∫–∞–µ–º —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ DataURL (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
        reader.readAsDataURL(file);
      });

      try {
        // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç—É—Ä—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏
        models[modelKey].settings.texture = await loadTexture;

        // –ï—Å–ª–∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç—É—Ä—ã –≤—ã–∫–ª—é—á–µ–Ω–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–≤–µ—Ç –º–æ–¥–µ–ª–∏ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É
        if (!isMixingEnabled.value) {
          models[modelKey].settings.color = models[modelKey].originalSettings.color;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –º–æ–¥–µ–ª–∏ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        await updateMaterials((material) => {
          applyMaterialSettings(material, modelKey);  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏ –≤ localStorage
        saveModelsToStorage();
      } catch (error) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–∫—Å—Ç—É—Ä—ã
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–∫—Å—Ç—É—Ä—ã:', error);
      }
    };

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ –ø–∞–ª–∏—Ç—Ä—É
    const changeColorFromPicker = (event) => {
      changeColor(event.target.value);
    };

    // –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–¥–µ–ª–∏
    const resetModelSettings = async () => {
      if (!model) return;

      const modelKey = model.userData.modelKey;
      if (!modelKey) return;

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö
      const originalSettings = models[modelKey].originalSettings;
      models[modelKey].settings = { ...originalSettings };

      await updateMaterials((material) => {applyMaterialSettings(material, modelKey);});

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage
      saveModelsToStorage();

      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å—Ü–µ–Ω—ã
      renderer.render(scene, camera);
    };

    // –§–ª–∞–≥ –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–∞—É–∑–æ–π
    let lastRotationDirection = null;

    // –§–ª–∞–≥ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤—Ä–∞—â–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
    let rotationStates = new Map(); // { modelKey: { clockwise: true/false, counterClockwise: true/false } }

    // –í—Ä–∞—â–µ–Ω–∏–µ –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ (–¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π)
    const rotateClockwise = () => {
      rotationStates.forEach((state) => {
        state.clockwise = true;
        state.counterClockwise = false;
      });
      lastRotationDirection = 'clockwise';
    };

    // –í—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ (–¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π)
    const rotateCounterClockwise = () => {
      rotationStates.forEach((state) => {
        state.clockwise = false;
        state.counterClockwise = true;
      });
      lastRotationDirection = 'counterclockwise';
    };

    // –ü–∞—É–∑–∞ / –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞—â–µ–Ω–∏—è (–¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π)
    const pauseRotation = () => {
      rotationStates.forEach((state) => {
        if (state.clockwise || state.counterClockwise) {
          state.clockwise = false;
          state.counterClockwise = false;
        } else {
          state.clockwise = lastRotationDirection === "clockwise";
          state.counterClockwise = lastRotationDirection === "counterclockwise";
        }
      });
    };

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Å–±—Ä–æ—Å –≤—Ä–∞—â–µ–Ω–∏—è (–¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π)
    const stopRotation = () => {
      sceneGroup.children.forEach((model) => {
        model.rotation.set(0, 0, 0);
      });

      rotationStates.forEach((state) => {
        state.clockwise = false;
        state.counterClockwise = false;
      });

      lastRotationDirection = null;
    };

    // –ü–æ–≤–æ—Ä–æ—Ç –Ω–∞ 180 –≥—Ä–∞–¥—É—Å–æ–≤ (–¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π)
    const rotate180 = () => {
      sceneGroup.children.forEach((model) => {
        model.rotation.y += Math.PI;
      });
    };

    const onWindowResize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();

      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    };

    window.addEventListener('resize', onWindowResize);

    onMounted(() => {
      init();
      onWindowResize();
    });

    onUnmounted(() => {
      window.removeEventListener('resize', onWindowResize);

      if (model) {
        model.traverse((child) => {
          if (child instanceof THREE.Mesh) {
            if (child.material) {
              if (Array.isArray(child.material)) {
                child.material.forEach((mat) => {
                  if (mat.map) mat.map.dispose(); // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ç–µ–∫—Å—Ç—É—Ä—ã
                  mat.dispose();
                });
              } else {
                if (child.material.map) child.material.map.dispose();
                child.material.dispose();
              }
            }
            if (child.geometry) {
              child.geometry.dispose();
            }
          }
        });
        scene.remove(model);
      }

      // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä–Ω–æ–≥–æ –∫–µ—à–∞
      Object.values(textureCache).forEach(texture => texture.dispose());

      scene.clear();
      renderer.dispose();
    });

    return {
      canvasContainer,
      models,
      loadModel,
      loadAllModels,
      isMultiModelView,
      uploadTexture,
      changeColor,
      changeColorFromPicker,
      changeTexture,
      toggleMixing, // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–º–µ—à–∏–≤–∞–Ω–∏—è
      isMixingEnabled, // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–º–µ—à–∏–≤–∞–Ω–∏—è
      resetModelSettings,
      rotateClockwise,
      rotateCounterClockwise,
      pauseRotation,
      stopRotation,
      rotate180,
    };
  },
};
</script>

<template>
  <div class="container">
    <h1>{{ $t('project3.name') }} <CanvasFullScreen :canvasContainer="canvasContainer"></CanvasFullScreen> <ToggleFullScreen></ToggleFullScreen></h1>
    <line></line>
    <div class="scene-container" ref="canvasContainer"></div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª—è–º–∏ -->
    <div class="model-selection">
      <img :src="models.menShirt1.icon" :alt="models.menShirt1.name" @click="loadModel('menShirt1')" class="button" :title="$t('models.menShirt1')">
      <img :src="models.womenShirt.icon" :alt="models.womenShirt.name" @click="loadModel('womenShirt')" class="button" :title="$t('models.womenShirt')">
      <img :src="models.menShirt2.icon" :alt="models.menShirt2.name" @click="loadModel('menShirt2')" class="button" :title="$t('models.menShirt2')">
      <img :src="models.womenDress.icon" :alt="models.womenDress.name" @click="loadModel('womenDress')" class="button" :title="$t('models.womenDress')">
      <button @click="loadAllModels" class="load-all-btn button" :title="$t('models.allModels')">
        <i class="fas fa-th-large"></i>
      </button>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–∞—â–µ–Ω–∏–µ–º -->
    <div class="rotation-controls">
      <button @click="rotateClockwise" :title="$t('rotating.clockwise')">
        <i class="fas fa-arrow-rotate-right"></i>
      </button>
      <button @click="pauseRotation" :title="$t('rotating.pause')">
        <i class="fas fa-pause"></i> <!-- –ò–∑–º–µ–Ω–∏–ª–∏ –∏–∫–æ–Ω–∫—É -->
      </button>
      <button @click="stopRotation" :title="$t('rotating.stop')">
        <i class="fas fa-stop"></i> <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ —Å reset-–ø–æ–∑–∏—Ü–∏–µ–π -->
      </button>
      <button @click="rotate180" :title="$t('rotating.180')">
        <i class="fas fa-sync-alt"></i> <!-- –ò–∫–æ–Ω–∫–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞ -->
      </button>
      <button @click="rotateCounterClockwise" :title="$t('rotating.counterclockwise')">
        <i class="fas fa-arrow-rotate-left"></i>
      </button>
    </div>

    <div class="model-controls" v-if="!isMultiModelView">
      <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ -->
      <div class="color-controls">
        <button @click="changeColor(0xd0d0fb)" :title="$t ('changeColor.blue')" class="color-button" style="background-color: #d0d0fb;"></button>
        <button @click="changeColor(0xfaeeb2)" :title="$t ('changeColor.golden')" class="color-button" style="background-color: #faeeb2;"></button>
        <input type="color" @input="changeColorFromPicker" :title="$t ('changeColor.picker')" class="color-button color-picker"/>
      </div>
      <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏ -->
      <div class="texture-controls">
        <img src="/assets/textures/texture2.webp" alt="texture2" @click="changeTexture('texture1')" class="button" :title="$t('texture.texture1')">
        <img src="/assets/textures/texture5.webp" alt="texture5" @click="changeTexture('texture2')" class="button" :title="$t('texture.texture2')">
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç—É—Ä—ã —Å –¥–∏—Å–∫–∞ -->
        <input type="file" @change="uploadTexture" id="file-input" class="file-input">
        <label for="file-input" class="button upload" :title="$t('texture.upload')">
          <i class="fa-solid fa-upload"></i>
        </label>
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
        <button @click="resetModelSettings" class="button reset" :title="$t('texture.reset')">
          <i class="fas fa-reply"></i>
        </button>
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Å–º–µ—à–∏–≤–∞–Ω–∏—è -->
        <button @click="toggleMixing" :title="isMixingEnabled ? $t('rotating.mixYes') : $t('rotating.mixNo')" class="mixing" :class="{'active': isMixingEnabled}">
          <i :class="isMixingEnabled ? 'fas fa-sliders-h' : 'fas fa-gem'"></i>
        </button>
      </div>
    </div>
  </div>
</template>

<style lang="scss" scoped>
.container {
  flex: 1 0 auto;
  background: linear-gradient(to bottom, rgb(229, 255, 229), rgb(250, 247, 234)) no-repeat center;
  h1 {font-size: 2.5rem;margin: 0.7rem auto;color: black;}
  .scene-container {
    max-height: 70vh;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .model-selection {
    position: absolute;
    top: 170px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;

    .button {
      width: 50px;
      height: 50px;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      //background-color: #a9ed9f;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
      transition: ease-in-out, color .2s, background-color .2s, box-shadow .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º —á–∞—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤—ã—Ö–æ–¥—è—â–∏–µ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */

      &:hover {
        //background-color: #2cbd03; /* –ë–æ–ª–µ–µ —è—Ä–∫–∏–π —Ü–≤–µ—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      img {
        width: 100%; /* –®–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —à–∏—Ä–∏–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        height: 100%; /* –í—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã—Å–æ—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        object-fit: cover; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        display: block; /* –£–±–∏—Ä–∞–µ—Ç –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
      }

    }

    .load-all-btn {
      background: #6f1f8e;
      color: white;
      font-size: 24px;
      .fas {color: white;}
    }
    .load-all-btn:hover {.fas {color: gold;} background: #9760aa;}
  }

  .rotation-controls {
    position: absolute;
    bottom: 80px; // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤–Ω–∏–∑
    left: 50%; // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
    transform: translateX(-50%); // –°–º–µ—â–∞–µ–º –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—É —à–∏—Ä–∏–Ω—ã
    display: flex;
    flex-direction: row; // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
    gap: 20px; // –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏

    button {
      width: 50px;
      height: 50px;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 24px;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #87ceeb;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
      transition: ease-in-out, background-color .2s, box-shadow .2s;

      &:hover {
        background-color: #00bfff; /* –ë–æ–ª–µ–µ —è—Ä–∫–∏–π —Ü–≤–µ—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
    }
  }

  .model-controls {
    position: absolute;
    left: 40px; /* –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Å–ª–µ–≤–∞ */
    top: 55%;
    transform: translateY(-50%);

    .color-controls {
      display: flex;
      flex-direction: column;

      .color-button {
        width: 50px;
        height: 50px;
        border: 1px solid #ccc;
        margin-bottom: 10px;
        cursor: pointer;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
        transition: background-color 0.2s, box-shadow 0.2s;

        &:hover {box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);}
      }
      .color-picker {
        padding: 0;
        border-radius: 5px;
      }
      .reset-button {
        background-color: #f0f0f0;
        border: 1px solid #ccc;

        &:hover {background-color: #e0e0e0;}
        .fas {font-size: 24px;}
      }
    }

    .texture-controls {
      display: flex;
      flex-direction: column;
      .button {
        width: 50px;
        height: 50px;
        margin-bottom: 10px;
        cursor: pointer;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
        transition: background-color 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º —á–∞—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤—ã—Ö–æ–¥—è—â–∏–µ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */

        .fa-solid, .fa-brands, .fas { font-size: 24px; }

        &:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }

        img {
          width: 100%; /* –®–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —à–∏—Ä–∏–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
          height: 100%; /* –í—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã—Å–æ—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
          object-fit: cover; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
          display: block; /* –£–±–∏—Ä–∞–µ—Ç –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        }
      }

      .upload {
        width: 50px;
        height: 50px;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
        background-color: dodgerblue;
        //background: linear-gradient(to bottom, rgb(229, 255, 229), rgb(250, 247, 234)) no-repeat center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.9);
        transition: ease-in-out, background-color .2s, box-shadow .2s;
        &:hover {
          background-color: mediumvioletred;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
      }

      .reset {
        color: black;
        background-color: #f0f0f0;
        border: 1px solid #ccc;

        &:hover {background-color: #e0e0e0;}
      }

      /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π input */
      .file-input {display: none;}

      .mixing {
        width: 50px;
        height: 50px;
        font-size: 24px;
        border: none;
        border-radius: 5px;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: red;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.9);
        transition: ease-in-out, background-color .2s, box-shadow .2s;
        &:hover {
          background-color: mediumvioletred;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
      }

      .active {
        background-color: darkgreen;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.9);
        transition: ease-in-out, background-color .2s, box-shadow .2s;
        &:hover {
          background-color: mediumseagreen;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
          i {transform: rotate(180deg); } /* –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–∫–æ–Ω–∫–∞ –º–æ–∂–µ—Ç –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è */
        }
      }

    }
  }
}

@media(max-width: 1020px) {
  .container {
    h1 {font-size: 2.3rem;margin: 0.6rem auto;}

    .model-selection {
      top: 165px;
      gap: 15px;

      .button {
        width: 45px;
        height: 45px;
      }
      .load-all-btn {display: none;}
    }

    .rotation-controls {
      bottom: 80px;
      gap: 15px;

      button {
        width: 45px;
        height: 45px;
        font-size: 22px;
      }
    }

    .model-controls {
      left: 22px; /* –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Å–ª–µ–≤–∞ */
      top: 54%;
      .color-controls {
        .color-button {
          width: 45px;
          height: 45px;
          margin-bottom: 9px;
        }
        .color-picker {
          width: 45px;
          height: 45px;
          margin-bottom: 9px;
        }
        .reset-button {
          .fas {font-size: 22px;}
        }
      }

      .texture-controls {
        .button {
          width: 45px;
          height: 45px;
          margin-bottom: 9px;
          .fa-solid,.fa-brands,.fas {font-size: 22px;}
        }
        .mixing {
          width: 45px;
          height: 45px;
          font-size: 22px;
        }
      }
    }
  }
}

@media (max-width: 768px) {
  .container {
    h1 {font-size: 2rem;margin: 0.5rem auto;}
    .model-selection {
      top: 150px;
      gap: 10px;

      .button {
        width: 40px;
        height: 40px;
      }
      .load-all-btn {display: none;}
    }

    .rotation-controls {
      bottom: 20px;
      gap: 10px;

      button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
    }

    .model-controls {
      left: 20px; /* –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Å–ª–µ–≤–∞ */
      top: 59%;
      .color-controls {
        .color-button {
          width: 40px;
          height: 40px;
          margin-bottom: 8px;
        }
        .color-picker {
          width: 40px;
          height: 40px;
          margin-bottom: 8px;
        }
        .reset-button {
          .fas {font-size: 18px;}
        }
      }

      .texture-controls {
        .button {
          width: 40px;
          height: 40px;
          margin-bottom: 8px;
          .fa-solid,.fa-brands,.fas {font-size: 18px;}
        }
        .mixing {
          width: 40px;
          height: 40px;
          font-size: 18px;
        }
      }
    }
  }
}
</style>